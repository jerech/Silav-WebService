<?php

	// Deshabilitar cache
	ini_set("soap.wsdl_cache_enabled", "0");

	require_once('lib/nusoap.php');

	$usuarioDB="u545571603_root";
	$contraseniaDB="js12345";
	$servidorDB="mysql.hostinger.es";
	$nombreDB='u545571603_silav';
		
	$urlns="www.silav.esy.es";

	//Se crea el servidor Soap
	$servidor=new soap_server;
	
	//Se configura el WSDL
	$servidor->configureWSDL('WSsilav',$urlns);
	$servidor->wsdl->schemaTargetNamespace=$urlns;
	
	//Se tienen que registrar las funciones que se van a usar
	
	$servidor->register('hola',
								array("nombre"=>'xsd:string'),
								array("return"=>'xsd:string'),
								$urlns);

	$servidor->register('conectarChofer',
								array("usuario"=>'xsd:string',"contrasenia"=>'xsd:string',"num_movil"=>'xsd:int',"estado"=>'xsd:string'),
								array("return"=>'xsd:boolean'),
								$urlns);
								
	$servidor->register('actualizarEstado',
								array("estado"=>'xsd:string',"usuario"=>'xsd:string'),
								array("return"=>'xsd:boolean'),
								$urlns);
								
	$servidor->register('actualizarUbicacion',
								array("usuario"=>'xsd:string',"ulatitud"=>'xsd:string',"ulongitud"=>'xsd:string'),
								array("return"=>'xsd:boolean'),
								$urlns);
								
 	$servidor->register('desconectarChofer',
 								array("usuario"=>'xsd:string',"num_movil"=>'xsd:int'),
 								array("return"=>'xsd:boolean'),
 								$urlns);
 								
 	$servidor->register('mensajeSos',
 								array("usuario"=>'xsd:string'),
 								array("return"=>'xsd:boolean'),
 								$urlns);
 								
 	$servidor->register('obtenerMoviles',
 								array("usuario"=>'xsd:string'),
 								array("return"=>'tns:ArregloMoviles'),
 								$urlns);
								
								
	//Se agregan las estructuras de datos necesarias
	
	$servidor->wsdl->addComplexType(
									'Movil',
									'complexType',
									'struct',
									'all',
									'',
									 array(
                        			'numero'            => array('name' => 'numero', 'type' => 'xsd:int'),
                        			'marca'            => array('name' => 'marca', 'type' => 'xsd:string'),
                        			'modelo'       => array('name' => 'modelo', 'type' => 'xsd:string' ),
                            ));
	$servidor->wsdl->addComplexType('ArregloMoviles',
												'complexType',
												'array',
												'',
												'SOAP-ENC:Array',
												 array(),
											    array(array('ref' => 'SOAP-ENC:arrayType',
											         'wsdl:arrayType' => 'tns:Movil[]')
											        ),
											    'tns:Movil');
								
	//Implementación de las funciones necesarias
	function hola($nombre) {
		return "Hola ".$nombre;

	}
		
	
	
	function conectarChofer($usuario, $contrasenia, $num_movil, $estado) {
			global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;
			$consultaOk = false;
			$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
			
			$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
			
			$consultaEsChoferRegistrado="select id, usuario from Choferes where usuario='$usuario' and contrasenia='$contrasenia'";
			$consultaChoferEstaConectado = "select usuario from ChoferesConectados where usuario='$usuario'";			
			$consultaConectarChofer = "insert into ChoferesConectados(usuario,numero_movil,estado_movil) values ('$usuario','$num_movil','$estado')";
		
			$totalCampos=mysql_num_rows(mysql_query($consultaEsChoferRegistrado));
			
			if($totalCampos==1){
				
				if(mysql_num_rows(mysql_query($consultaChoferEstaConectado)) == 0){
					$consultaOk = mysql_query($consultaConectarChofer);
					
				}else {
					$consultaOk=false;
					
				}
			}else {
				$consultaOk = false;
			}
		
			mysql_close($com);
		
			return $consultaOk;
						
		}	
	function actualizarEstado($estado,$usuario) {
		global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;

			$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
			
			$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
		
		$consulta="update ChoferesConectados set estado_movil='$estado' where usuario='$usuario'";
		$consultaOk=mysql_query($consulta);
		mysql_close($com);
		
		return $consultaOk;
		
	}


	function actualizarUbicacion($usuario, $ulatitud, $ulongitud) {
		
		global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;
		$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
		$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
		
		$consulta="update ChoferesConectados set ubicacion_lat='$ulatitud', ubicacion_lon='$ulongitud' where usuario='$usuario'";
		$consultaOk=mysql_query($consulta);
		mysql_close($com);
		
		return $consultaOk;
	}

function desconectarChofer($usuario, $num_movil) {
		global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;
		$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
		$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
		$consultaEliminarChoferConectado = "delete from ChoferesConectados where usuario='$usuario' and numero_movil='$num_movil'";
		
		$consultaOk=mysql_query($consultaEliminarChoferConectado);
		mysql_close($com);
		
		return $consultaOk;

}

function obtenerMoviles($usuario) {
	global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;
		$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
		$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
		
		$consultaMovilesChofer = "SELECT Moviles.numero, Moviles.marca, Moviles.modelo FROM Moviles INNER JOIN AsignacionesMovil ON Moviles.id = AsignacionesMovil.id_movil INNER JOIN Choferes ON AsignacionesMovil.id_chofer = Choferes.id WHERE Choferes.usuario='$usuario' order by Moviles.numero";
		
		$resultado = mysql_query($consultaMovilesChofer);
		$c=0;
		while($registro=mysql_fetch_array($resultado)) {
				$moviles[$c]['numero']=$registro[0];
				$moviles[$c]['marca']=$registro[1];
				$moviles[$c]['modelo']=$registro[2];
				$c++;
			}
		return $moviles;
}

function mensajeSos($usuario) {
	global $usuarioDB,$contraseniaDB,$servidorDB,$nombreDB;
		$com=mysql_connect($servidorDB, $usuarioDB, $contraseniaDB); 
			if(!$com){
				die('No se pudo conectar:'.mysql_error());
							
			}
		$bd_seleccionada=mysql_select_db($nombreDB);
			if(!$bd_seleccionada){
				die('No se puede usar '.$nombreDB.':'.mysql_error());			
			}
		
		$consulta = "update ChoferesConectados set sos=true where usuario='$usuario'";
		$consultaOk=mysql_query($consulta);
		mysql_close($com);
		
		return $consultaOk;
}
	
	$servidor->service($HTTP_RAW_POST_DATA);
	

?>